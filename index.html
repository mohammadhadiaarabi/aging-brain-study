<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Lifespan of the Corpus Callosum</title>
    <!-- Chosen Palette: Cognitive Harmony -->
    <!-- Application Structure Plan: The SPA is designed as a single-page, narrative-driven journey to make the complex research accessible. It's structured into five thematic sections that guide the user from the foundational concept of the Corpus Callosum to the study's most novel findings. This narrative flow (Intro -> What is Differential Aging? -> How does it relate to cognition? -> How does age change everything? -> Conclusion) is more intuitive for exploration than a traditional report structure. Key interactions, like highlighting chart data and toggling views, are integrated into each section to let users actively engage with and understand each of the study's three core findings. -->
    <!-- Visualization & Content Choices (Updated with Full Dataset): 
         1. Finding: Differential Aging across networks. Goal: Compare change over time. Viz: Interactive multi-line chart. Interaction: Click buttons to highlight a network's trajectory. Justification: Now visualizes the full dataset from the provided CSV, showing robust trends in how different brain networks age. Library: Chart.js.
         2. Finding: Brain-behavior relationships. Goal: Compare correlations. Viz: Interactive bar chart. Interaction: Select a cognitive domain from a dropdown to update the chart. Justification: Provides a comprehensive, direct comparison of the strength of these relationships across multiple cognitive functions, now calculated from all subjects. Library: Chart.js.
         3. Finding: Age as a moderator. Goal: Show a changing relationship. Viz: Interactive scatter plot. Interaction: Toggle between "Younger" and "Older" adult views. Justification: This effectively visualizes the moderation effect using all participant data, offering a clear view of how age impacts the brain-cognition link. Library: Plotly.js.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js" charset="utf-8"></script>
    <!-- This line loads the full dataset from your external file -->
    <script src="data.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #FBFBF9;
            color: #383838;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 500px;
            }
        }
        .nav-link {
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .nav-link.active, .nav-link:hover {
            color: #D97706; 
            border-bottom-color: #D97706;
        }
        .control-btn {
            transition: all 0.3s ease;
        }
        .control-btn.active {
            background-color: #D97706;
            color: #FFFFFF;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .network-btn.active {
             background-color: #4B5563;
             color: #FFFFFF;
        }
        /* Custom select style */
        .custom-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%236B7280%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22/%3E%3C/svg%3E');
            background-repeat: no-repeat;
            background-position: right .7em top 50%;
            background-size: .65em auto;
        }
    </style>
</head>
<body class="antialiased">

    <header class="bg-white/80 backdrop-blur-md sticky top-0 z-50 border-b border-gray-200">
        <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <span class="font-bold text-xl text-amber-700">ðŸ§  The Aging Brain</span>
                </div>
                <div class="hidden md:block">
                    <div class="ml-10 flex items-baseline space-x-4">
                        <a href="#introduction" class="nav-link text-gray-600 hover:text-amber-600 px-3 py-2 rounded-md text-sm font-medium border-b-2 border-transparent">Introduction</a>
                        <a href="#differential-aging" class="nav-link text-gray-600 hover:text-amber-600 px-3 py-2 rounded-md text-sm font-medium border-b-2 border-transparent">Differential Aging</a>
                        <a href="#brain-behavior" class="nav-link text-gray-600 hover:text-amber-600 px-3 py-2 rounded-md text-sm font-medium border-b-2 border-transparent">Mind & Matter</a>
                        <a href="#age-moderation" class="nav-link text-gray-600 hover:text-amber-600 px-3 py-2 rounded-md text-sm font-medium border-b-2 border-transparent">The Age Factor</a>
                        <a href="#conclusion" class="nav-link text-gray-600 hover:text-amber-600 px-3 py-2 rounded-md text-sm font-medium border-b-2 border-transparent">Conclusion</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>

    <main>
        <section id="introduction" class="py-20 md:py-32 bg-white">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h1 class="text-4xl md:text-6xl font-bold tracking-tight text-gray-800">The Brain's Information Highway</h1>
                <p class="mt-6 text-lg md:text-xl text-gray-600 leading-8">
                    This is an exploration of the Corpus Callosum, the vital bridge connecting our brain's hemispheres. Using the full dataset from the Human Connectome Project - Aging study, we'll see how this structure ages, how its decline impacts our thinking, and why its health becomes increasingly critical as we grow older.
                </p>
                <div class="mt-10">
                    <a href="#differential-aging" class="inline-block bg-amber-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-amber-700 transition-transform transform hover:scale-105">
                        Begin the Journey
                    </a>
                </div>
            </div>
        </section>

        <section id="differential-aging" class="py-20 md:py-28">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-800">A Mosaic of Aging</h2>
                    <p class="mt-4 max-w-3xl mx-auto text-lg text-gray-600">
                        The Corpus Callosum doesn't age uniformly. Its fibers connect to different functional networks in the brain, and each of these connections follows a unique lifespan trajectory. This section visualizes this "differential aging," showing how some networks decline faster than others, consistent with the "last in, first out" principle of brain aging.
                    </p>
                </div>
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                    <div class="chart-container mx-auto">
                        <canvas id="lifespanChart"></canvas>
                    </div>
                    <div class="mt-8 text-center">
                        <p class="text-sm text-gray-500 mb-4">Click a network to highlight its trajectory and learn more.</p>
                        <div id="network-buttons" class="flex flex-wrap justify-center gap-2 md:gap-3">
                        </div>
                    </div>
                    <div id="network-info" class="mt-6 p-4 bg-amber-50 rounded-lg min-h-[100px] flex items-center justify-center">
                        <p class="text-center text-amber-800 font-medium">Select a network to see its details.</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="brain-behavior" class="py-20 md:py-28 bg-white">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-800">The Mind-Matter Connection</h2>
                    <p class="mt-4 max-w-3xl mx-auto text-lg text-gray-600">
                        How does the physical health of these brain connections relate to our cognitive and motor abilities? This section explores the link between the integrity of network-specific callosal fibers and performance on a range of key tests. The data reveals that high-order association networks are particularly crucial for complex cognition.
                    </p>
                </div>
                <div class="bg-gray-50 p-6 md:p-8 rounded-2xl shadow-lg">
                    <div class="text-center mb-6">
                        <label for="cognitive-test-selector" class="block text-sm font-medium text-gray-700 mb-2">Select a Cognitive or Motor Domain:</label>
                        <select id="cognitive-test-selector" class="custom-select block w-full max-w-xs mx-auto mt-1 rounded-md border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500 sm:text-sm py-2 px-3 bg-white">
                            <!-- Options will be populated by script -->
                        </select>
                    </div>
                    <div class="chart-container mx-auto">
                        <canvas id="correlationChart"></canvas>
                    </div>
                     <div id="correlation-info" class="mt-6 p-4 bg-blue-50 rounded-lg">
                         <p class="text-center text-blue-800 font-medium">Correlations between network integrity and the selected test score. Higher bars indicate a stronger relationship.</p>
                     </div>
                </div>
            </div>
        </section>

        <section id="age-moderation" class="py-20 md:py-28">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-12">
                    <h2 class="text-3xl md:text-4xl font-bold text-gray-800">The Age Factor</h2>
                    <p class="mt-4 max-w-3xl mx-auto text-lg text-gray-600">
                        This is the study's most novel finding. The relationship between brain structure and cognition is not staticâ€”it changes dramatically with age. In younger adults, the link is weaker. In older adults, cognitive performance becomes much more dependent on the physical integrity of the Corpus Callosum.
                    </p>
                </div>
                <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg">
                    <div class="flex justify-center items-center mb-6 gap-4">
                         <div class="inline-flex rounded-md shadow-sm" role="group">
                            <button type="button" id="btn-young" class="control-btn active py-2 px-4 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100">
                                Younger Adults (&lt;50)
                            </button>
                            <button type="button" id="btn-old" class="control-btn py-2 px-4 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-md hover:bg-gray-100">
                                Older Adults (50+)
                            </button>
                        </div>
                    </div>
                    <div class="chart-container mx-auto" id="moderationPlot"></div>
                    <div id="moderation-info" class="mt-6 p-4 bg-green-50 rounded-lg min-h-[100px] flex items-center justify-center">
                        <p class="text-center text-green-800 font-medium leading-relaxed">
                            <b>In Younger Adults:</b> With high neural reserve, cognitive performance is less dependent on any single structural component. The brain can easily compensate.
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <section id="conclusion" class="py-20 md:py-32 bg-gray-800 text-white">
            <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
                <h2 class="text-3xl md:text-4xl font-bold">A Blueprint for Cognitive Aging</h2>
                <p class="mt-6 text-lg text-gray-300 leading-8">
                    The Corpus Callosum is a mosaic of connections that age at different rates. The integrity of this structure, especially the fibers supporting high-order association networks, becomes an increasingly critical and rate-limiting factor for maintaining cognitive function in later life. These findings underscore the importance of preserving white matter health as a key target for interventions aimed at promoting successful cognitive aging.
                </p>
            </div>
        </section>
    </main>
    
    <footer class="bg-white border-t border-gray-200">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-500">
            <p>Interactive summary using data from the Human Connectome Project - Aging study.</p>
        </div>
    </footer>

<script>
// The ALL_DATA constant is now loaded from the external 'data.js' file
// which is included in the <head> of this document.

document.addEventListener('DOMContentLoaded', function () {

    // --- DATA PREPARATION ---
    // This function cleans the raw data, converting strings to numbers and handling missing values.
    function cleanData(data) {
        const numericColumns = [
            'Tract_Density', 'interview_age', 'moca_total', 'pea_ravlt_sd_tc', 
            'pea_ravlt_ld_tc', 'nih_patterncomp_ageadjusted', 'tpvt_acsstbx_vocab_theta',
            'tmta_raw', 'tmtb_raw', 'loco_comscore'
        ];
        return data.map(row => {
            let cleanedRow = { ...row };
            for (const col of numericColumns) {
                // Ensure the value is not null, undefined, or an empty string before converting
                if (cleanedRow[col] != null && cleanedRow[col] !== '') {
                    const num = parseFloat(cleanedRow[col]);
                    cleanedRow[col] = isNaN(num) ? null : num;
                } else {
                    cleanedRow[col] = null;
                }
            }
            // Clean up network names that might have extra spaces
            if (typeof cleanedRow.Network === 'string') {
                cleanedRow.Network = cleanedRow.Network.trim();
            }
            return cleanedRow;
        }).filter(row => row.Network && row.Tract_Density != null); // Filter out rows with no network or tract density
    }

    const PROCESSED_DATA = cleanData(ALL_DATA);

    const networkNames = {
        'Vis': 'Visual', 'SomMot': 'Somatomotor', 'DorsAttn': 'Dorsal Attention',
        'SalVentAttn': 'Salience', 'Limbic': 'Limbic', 'Cont': 'Control', 'Default': 'Default Mode'
    };
    const networkColors = ['#3B82F6', '#10B981', '#F97316', '#EF4444', '#6366F1', '#8B5CF6', '#EC4899'];
    const networkInfoTexts = {
        'Visual': 'The Visual network, responsible for processing sight, shows relatively early maturation and a gradual, steady decline.',
        'Somatomotor': 'Connecting sensory and motor cortices, this network follows a typical lifespan curve with moderate decline.',
        'Dorsal Attention': 'Crucial for focus and attention, this network peaks later and shows a more pronounced age-related decline.',
        'Salience': 'The Salience network, which helps detect important stimuli, shows significant vulnerability in later life.',
        'Limbic': 'Involved in emotion and memory, the Limbic network has a relatively stable trajectory compared to association networks.',
        'Control': 'A key executive function network, the Control network follows the "last in, first out" principle with a late peak and sharp decline.',
        'Default Mode': 'Active during rest and introspection, the Default Mode network is one of the last to mature and among the first to show significant aging effects.'
    };
    
    const cognitiveTests = {
        'General Cognitive (MoCA)': 'moca_total',
        'Attention (TMT-A)': 'tmta_raw',
        'Executive Function (TMT-B)': 'tmtb_raw',
        'Memory (AVLT-Short)': 'pea_ravlt_sd_tc',
        'Memory (AVLT-Long)': 'pea_ravlt_ld_tc',
        'Language (Vocabulary)': 'tpvt_acsstbx_vocab_theta',
        'Visuospatial Function': 'nih_patterncomp_ageadjusted',
        'Motor Behavior': 'loco_comscore'
    };


    // 1. Lifespan Data Processing
    function getLifespanData() {
        const ageBins = { '36-45':[], '45-55':[], '55-65':[], '65-75':[], '75+':[] };
        PROCESSED_DATA.forEach(row => {
            const age = row.interview_age / 12;
            let bin;
            if (age < 45) bin = '36-45';
            else if (age < 55) bin = '45-55';
            else if (age < 65) bin = '55-65';
            else if (age < 75) bin = '65-75';
            else bin = '75+';
            if(bin && ageBins[bin]) {
                ageBins[bin].push(row);
            }
        });

        const networkTrajectories = {};
        Object.keys(networkNames).forEach(net => {
            networkTrajectories[net] = [];
        });

        const labels = Object.keys(ageBins);
        labels.forEach(bin => {
            const binData = ageBins[bin];
            Object.keys(networkNames).forEach(net => {
                const networkPoints = binData.filter(d => d.Network === net);
                if (networkPoints.length > 0) {
                    const avgDensity = networkPoints.reduce((acc, curr) => acc + curr.Tract_Density, 0) / networkPoints.length;
                    networkTrajectories[net].push(avgDensity);
                } else {
                    networkTrajectories[net].push(null);
                }
            });
        });
        
        return {
            labels: labels,
            datasets: Object.keys(networkNames).map((net, i) => ({
                name: networkNames[net],
                data: networkTrajectories[net],
                color: networkColors[i],
                info: networkInfoTexts[networkNames[net]]
            }))
        };
    }

    // 2. Correlation Data Processing
    function pearsonCorrelation(x, y) {
        let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0, sumY2 = 0;
        const n = x.length;
        for (let i = 0; i < n; i++) {
            sumX += x[i];
            sumY += y[i];
            sumXY += (x[i] * y[i]);
            sumX2 += (x[i] * x[i]);
            sumY2 += (y[i] * y[i]);
        }
        const numerator = n * sumXY - sumX * sumY;
        const denominator = Math.sqrt((n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY));
        if (denominator === 0) return 0;
        const r = numerator / denominator;
        // For TMT and Motor scores, lower is better, so flip the correlation for interpretability
        return (y.name === 'tmta_raw' || y.name === 'tmtb_raw' || y.name === 'loco_comscore') ? -r : r;
    }

    function getCorrelationData() {
        const allCorrelations = {};
        const labels = Object.values(networkNames);

        Object.entries(cognitiveTests).forEach(([testName, testKey]) => {
            const correlations = [];
            Object.keys(networkNames).forEach(net => {
                const networkData = PROCESSED_DATA.filter(d => d.Network === net && d[testKey] != null);
                if (networkData.length > 1) {
                    const densities = networkData.map(d => d.Tract_Density);
                    const scores = networkData.map(d => d[testKey]);
                    scores.name = testKey; // Pass test key for correlation direction check
                    correlations.push(pearsonCorrelation(densities, scores));
                } else {
                    correlations.push(0);
                }
            });
            allCorrelations[testKey] = {
                labels: labels,
                values: correlations,
                color: 'rgba(59, 130, 246, 0.6)'
            };
        });
        return allCorrelations;
    }

    // 3. Moderation Plot Data Processing
    function getModerationData(testKey) {
        const subjectData = {};
        PROCESSED_DATA.forEach(row => {
            if (row[testKey] == null) return;
            if (!subjectData[row.Subject]) {
                subjectData[row.Subject] = {
                    age: row.interview_age / 12,
                    cognition: row[testKey],
                    densities: [],
                };
            }
            subjectData[row.Subject].densities.push(row.Tract_Density);
        });

        const plotPoints = Object.values(subjectData).map(subj => ({
            integrity: subj.densities.reduce((a, b) => a + b, 0) / subj.densities.length,
            cognition: subj.cognition,
            ageGroup: subj.age < 50 ? 'young' : 'old'
        }));

        return {
            young: plotPoints.filter(p => p.ageGroup === 'young'),
            old: plotPoints.filter(p => p.ageGroup === 'old')
        };
    }

    const lifespanData = getLifespanData();
    const correlationData = getCorrelationData();
    let currentTestKey = 'nih_patterncomp_ageadjusted'; // Default test
    
    const moderationInfoText = {
        young: "<b>In Younger Adults:</b> With high neural reserve, cognitive performance is less dependent on any single structural component. The brain can easily compensate, hence the weaker link.",
        old: "<b>In Older Adults:</b> As neural reserve declines, performance becomes highly dependent on the underlying structural 'hardware.' The integrity of the Corpus Callosum is now a critical factor for successful cognition."
    };

    let lifespanChart, correlationChart;
    let activeNetworkIndex = -1;
    let activeAgeGroup = 'young';

    // --- CHART CREATION & CONTROLS ---

    function createLifespanChart() {
        const ctx = document.getElementById('lifespanChart').getContext('2d');
        lifespanChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: lifespanData.labels,
                datasets: lifespanData.datasets.map(net => ({
                    label: net.name,
                    data: net.data,
                    borderColor: net.color,
                    backgroundColor: net.color + '33',
                    borderWidth: 2.5,
                    fill: false,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHitRadius: 10
                }))
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                scales: {
                    y: { title: { display: true, text: 'Tract Density (Sum)' } },
                    x: { title: { display: true, text: 'Age Group (Years)' } }
                }
            }
        });
    }

    function createCorrelationChart(testKey) {
        const ctx = document.getElementById('correlationChart').getContext('2d');
        const data = correlationData[testKey];
        correlationChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.labels,
                datasets: [{
                    label: 'Correlation Strength',
                    data: data.values,
                    backgroundColor: data.color,
                    borderColor: data.color.replace('0.6', '1'),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: { callbacks: { label: context => `Correlation: ${context.raw.toFixed(3)}` } }
                },
                scales: { x: { title: { display: true, text: 'Brain-Behavior Correlation (r)' }, beginAtZero: false } }
            }
        });
    }
    
    function updateCorrelationChart(testKey) {
        if (correlationChart) {
            const data = correlationData[testKey];
            correlationChart.data.labels = data.labels;
            correlationChart.data.datasets[0].data = data.values;
            correlationChart.update();
        }
    }

    function createModerationPlot(testKey, ageGroup) {
        const moderationData = getModerationData(testKey);
        const plotDiv = document.getElementById('moderationPlot');
        const dataForGroup = moderationData[ageGroup];

        const trace = {
            x: dataForGroup.map(p => p.integrity),
            y: dataForGroup.map(p => p.cognition),
            mode: 'markers', type: 'scatter',
            name: ageGroup === 'young' ? 'Younger Adults' : 'Older Adults',
            marker: { 
                color: ageGroup === 'young' ? 'rgba(59, 130, 246, 0.7)' : 'rgba(217, 119, 6, 0.7)', 
                size: 8 
            }
        };

        const selectedTestName = Object.keys(cognitiveTests).find(key => cognitiveTests[key] === testKey);

        const layout = {
            xaxis: { title: 'Corpus Callosum Integrity (Sum Density)'},
            yaxis: { title: `${selectedTestName} Score` },
            showlegend: false, margin: { l: 60, r: 20, b: 50, t: 40 }, hovermode: 'closest'
        };

        Plotly.react(plotDiv, [trace], layout, {responsive: true, displayModeBar: false});
    }

    function setupNetworkControls() {
        const container = document.getElementById('network-buttons');
        const infoEl = document.getElementById('network-info');
        lifespanData.datasets.forEach((net, index) => {
            const button = document.createElement('button');
            button.textContent = net.name;
            button.className = 'network-btn control-btn py-2 px-3 text-xs md:text-sm font-medium text-gray-700 bg-gray-100 border border-gray-200 rounded-md hover:bg-gray-200';
            button.dataset.index = index;
            container.appendChild(button);

            button.addEventListener('click', () => {
                activeNetworkIndex = (activeNetworkIndex === index) ? -1 : index;
                
                document.querySelectorAll('#network-buttons .network-btn').forEach((btn, i) => {
                    btn.classList.toggle('active', i === activeNetworkIndex);
                });

                lifespanChart.data.datasets.forEach((dataset, i) => {
                    if (activeNetworkIndex === -1) {
                        dataset.borderWidth = 2.5;
                        dataset.borderColor = lifespanData.datasets[i].color;
                    } else {
                        const isActive = i === activeNetworkIndex;
                        dataset.borderWidth = isActive ? 5 : 2;
                        dataset.borderColor = isActive ? lifespanData.datasets[i].color : '#e5e7eb';
                    }
                });
                lifespanChart.update();

                if (activeNetworkIndex !== -1) {
                    infoEl.innerHTML = `<p class="text-center text-amber-800 font-medium">${lifespanData.datasets[activeNetworkIndex].info}</p>`;
                } else {
                    infoEl.innerHTML = `<p class="text-center text-amber-800 font-medium">Select a network to see its details.</p>`;
                }
            });
        });
    }

    function setupCorrelationControls() {
        const selector = document.getElementById('cognitive-test-selector');
        Object.entries(cognitiveTests).forEach(([name, key]) => {
            const option = document.createElement('option');
            option.value = key;
            option.textContent = name;
            if (key === currentTestKey) option.selected = true;
            selector.appendChild(option);
        });

        selector.addEventListener('change', (e) => {
            currentTestKey = e.target.value;
            updateCorrelationChart(currentTestKey);
            createModerationPlot(currentTestKey, activeAgeGroup);
        });
    }

    function setupModerationControls() {
        const btnYoung = document.getElementById('btn-young');
        const btnOld = document.getElementById('btn-old');
        const infoEl = document.getElementById('moderation-info');
        
        btnYoung.addEventListener('click', () => {
            activeAgeGroup = 'young';
            createModerationPlot(currentTestKey, activeAgeGroup);
            btnYoung.classList.add('active');
            btnOld.classList.remove('active');
            infoEl.innerHTML = `<p class="text-center text-green-800 font-medium leading-relaxed">${moderationInfoText.young}</p>`;
        });
        btnOld.addEventListener('click', () => {
            activeAgeGroup = 'old';
            createModerationPlot(currentTestKey, activeAgeGroup);
            btnOld.classList.add('active');
            btnYoung.classList.remove('active');
            infoEl.innerHTML = `<p class="text-center text-green-800 font-medium leading-relaxed">${moderationInfoText.old}</p>`;
        });
    }
    
    function setupNavScroll() {
        const sections = document.querySelectorAll('main section');
        const navLinks = document.querySelectorAll('header nav a');

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    navLinks.forEach(link => {
                        link.classList.remove('active');
                        if (link.getAttribute('href').substring(1) === entry.target.id) {
                            link.classList.add('active');
                        }
                    });
                }
            });
        }, { rootMargin: "-50% 0px -50% 0px" });

        sections.forEach(section => {
            observer.observe(section);
        });
    }

    // --- INITIALIZE ---
    createLifespanChart();
    setupNetworkControls();
    createCorrelationChart(currentTestKey);
    setupCorrelationControls();
    createModerationPlot(currentTestKey, activeAgeGroup);
    setupModerationControls();
    setupNavScroll();
});
</script>
</body>
</html>

